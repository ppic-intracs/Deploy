<pre>
  <code>
import matplotlib.pyplot as plt
import serial
import csv
import time
import numpy as np
import time
from datetime import datetime

# --- Konstanta ---
NUM_BEAMS = 136
SCAN_HEIGHT_M = 3.0
PITCH = SCAN_HEIGHT_M / NUM_BEAMS  # ≈ 0.022 m per beam
tinggi = []

# --- Serial config ---

def beam_to_height(beam_idx: int) -> float:
    """Konversi nomor beam tertinggi tertutup → tinggi dalam meter."""
    if beam_idx <= 0 or beam_idx > NUM_BEAMS:
        return 0.0
    return beam_idx * PITCH

def moving_average(x, w=5):
    return np.convolve(x, np.ones(w)/w, mode='valid')

def classify_vehicle(heights):
    if len(heights) < 5:
        return "UNKNOWN"

    H_p95 = np.percentile(heights, 95)
    H_mean = np.mean(heights)
    H_std = np.std(heights)   # variasi profil

    dH = np.diff(heights)
    ΔH_max_up = max(
        [np.sum(dH[i:i+3]) for i in range(len(dH)-2)], default=0
    )

    K = np.abs(np.diff(heights, n=2))
    K_mean = np.mean(K) if len(K) > 0 else 0

    # Hitung plateau
    plateaus = 0
    tol = 0.02
    run_len = 1
    for i in range(1, len(heights)):
        if abs(heights[i] - heights[i-1]) < tol:
            run_len += 1
        else:
            if run_len >= 10:
                plateaus += 1
            run_len = 1
    if run_len >= 10:
        plateaus += 1

    # --- Aturan baru ---
    # 1. Bus (atap tinggi & rata)
    print("Tinggi   : ", f"{H_p95:.3f}")
    tinggi.append(f"{H_p95:.3f}")
    tinggi.append(f"{H_std:.3f}")
    print("Kerataan : ", f"{H_std:.3f}")

    if H_p95 >= 2.8 and H_std < 0.09:
        return "BUS"

    if H_p95 <= 2.8 and H_std < 0.09:
        return "BUS KECIL"

    if H_p95 >= 2.8 and H_std > 0.09:
        return "TRUK"

    if H_p95 <= 2.8 and H_std > 0.09:
        return "TRUK KECIL"

def main():
    # === Konfigurasi Serial ===
    ser = serial.Serial('COM9', 19200, timeout=1)
    time.sleep(1)  # tunggu koneksi stabil
    raw = ser.read_until(b'\r')
    #print(raw)
    if raw == b'' or raw == b'\xfc': #cek bahwa tidak ada data
        print("Profiling scanner idle")
        data = bytes([0x53, 0x59, 0x4E, 0x0D, 0x0A])
        ser.write(data)
    else:
        print("Profiling scanner ready")
    #===============================================

    filename = "datalog.csv"
    flag = False
    heights = []

    with open(filename, mode='a', newline='') as file:
        writer = csv.writer(file)

        print("Mulai membaca data serial... Tekan CTRL+C untuk berhenti.")
        try:
            while True:
                if ser.in_waiting > 0:
                    raw = ser.read_until(b'\r')  # baca sampai CR (0x0D)
                    #print(raw)
                    if raw != (b'\x01<SYSTEM ARMED>\r'): 
                        data = raw.decode('ascii', errors='ignore').strip()   
                        dec_value = int(data,16)
                        if dec_value>136:
                            dec_value=136
                            #print(dec_value)
                        #print(dec_value)

                        if dec_value != 0:                
                            # Simpan ke excel
                            writer.writerow([dec_value])
                            h = beam_to_height(dec_value)
                            heights.append(h)
                            flag = True
                        else:
                            if flag:                                    
                                del heights[0:3]            # Potong 10% data awal                                    
                                del heights[-2:]            # Potong 10% data akhir

                                if len(heights)!=0:
                                    #print(heights)
                                    H_smoothed = moving_average(np.array(heights), w=5)
                                    kelas = classify_vehicle(H_smoothed)
                                    print(f"Kendaraan terdeteksi: {kelas}\n")
                                    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                                    writer.writerow([kelas])
                                    writer.writerow([timestamp])
                                    flag = False
                                    #buat gambar
                                    heights.insert(0,0)
                                    #print(heights)
                                    data = (heights)
                                    plt.clf()       
                                    plt.plot(range(1, len(data)+1), data, marker='', linestyle='-', color='royalblue')
                                    #print(tinggi)
                                    hasil = [kelas] + tinggi
                                    plt.title(hasil)
                                    plt.xlabel('Index')
                                    plt.ylabel('Nilai')
                                    plt.grid(True, axis='y', linestyle='-', color='gray', alpha=0.5)
                                    timestamp = datetime.now().strftime('%Y%m%d-%H%M%S')
                                    x= f"{timestamp}.png"
                                    plt.savefig(x)
                                    heights.clear()
                                    tinggi.clear()

        except KeyboardInterrupt:        
            #data = bytes([0x1B, 0x1B, 0x0D, 0x0A])
            #ser.write(data)
            #print("Kirim perintah stop scan")
            ser.close()
            print("Program Exit")

if __name__ == "__main__":
    main()
  </code>
</pre>
